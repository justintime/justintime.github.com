
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Case Study in Migrating XML to Drupal Using Migrate - SysAdmin's Journey</title>
  <meta name="author" content="Justin Ellison">

  
  <meta name="description" content="Sorry for the lack of posts as of late &ndash; a massive upgrade operation at
$DAYJOB has had me out of commission for a few weeks. Also, I&rsquo;ve &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://sysadminsjourney.com/content/2010/07/14/case-study-migrating-xml-drupal-using-migrate">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="SysAdmin's Journey" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-5430710-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">SysAdmin's Journey</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="sysadminsjourney.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/contact">Contact</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Case Study in Migrating XML to Drupal Using Migrate</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2010-07-14T00:00:00-05:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>14</span><span class='date-suffix'>th</span>, <span class='date-year'>2010</span></span> <span class='time'>12:00 am</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Sorry for the lack of posts as of late &ndash; a massive upgrade operation at
$DAYJOB has had me out of commission for a few weeks. Also, I&rsquo;ve had the great
fortune to be able to be part of a migration to Drupal which exposed me to
<a href="http://drupal.org/project/migrate">migrate</a> and friends. Yes, I said &ldquo;great
fortune&rdquo; in the same sentence with &ldquo;migration&rdquo; without using a negative -
that&rsquo;s just how awesome this module is. My first impression when looking at
the documentation for migrate was that it didn&rsquo;t seem complete. While it&rsquo;s
true that the documentation could be better (what module couldn&rsquo;t use better
documentation?), the problem is that no two migrations are alike. Because of
this, the best documentation is not going to be written by the module authors,
it will be written by the module <em>users</em> - they are the ones that come up with
the recipies to fill the cookbook. There are several good reasons why there
aren&rsquo;t many recipes available:</p>

<ul>
<li>Developers don&rsquo;t like doing migrations. It can be painful, and often takes quite a bit of time.</li>
<li>Users don&rsquo;t like migrations. They see a migration of data as something easily done, and they often get sticker shock when presented with estimates for a large migration.</li>
<li>Migration code is written in a flurry before the site is active. Right before launch, development crescendos, and then is often never used again (because no two migrations are the same).
This being my first migration, I vowed that I would document my experience,
because I learned so much from it. In this particular migration, we had to
migrate a huge XML file into about 2,200 nodes in 3 content types. Read on for
my contribution to the cookbook! First, some discussion on the general
workflow and some design decisions. Since I had to get XML into the database
before I could run the migrate, I wrote a command line script to do just that.
When you need to manipulate data between your source and destination (i.e.,
change all references to www.olddomain.com to www.newdomain.com), you usually
have to do this via the hooks that the migrate module provides. In my case,
there were a few cases where doing the data munging in the command line script
was much easier than doing it within the hooks. The problem with making
transformations within the command line script is that with every change, I
had to re-run the script. This wasn&rsquo;t a big deal, as the XML to MySQL script
took around 15 seconds to complete. I also quickly discovered that if you have
less than 10 entities of one type (Story content type, user, etc), it&rsquo;s
usually better to just hand-migrate them. The most straight-forward migration
will take 1 hour at a minimum to setup and test &ndash; if it will take less than
that to copy/paste, save your time and do it the less sexy way. Since we had
to transform the XML into MySQL tables, and there was a lot of data in the XML
that we didn&rsquo;t need, I decided the best way to dynamically change what we
import and what we didn&rsquo;t was by using hook_install() and Drupal&rsquo;s DB schema
API. By naming the MySQL table columns the same as the XML attributes, we can
add and remove data to be transformed quite easily. Lastly, I need to re-
iterate that this was my first migration. What I describe here works for me,
but may very well not be the best way to do it. Also, I will not duplicate
what you can learn from the migrate module documentation, so make sure to read
that first. Let me know any suggestions you may have in the comments.</li>
</ul>


<h2>Install Module Dependencies</h2>

<p>The first step is to install module dependencies. You&rsquo;ll need
<a href="http://drupal.org/project/views">Views</a>,
<a href="http://drupal.org/project/schema">Schema</a>, <a href="http://drupal.org/project/tw">Table Wizard(tw)</a>. You&rsquo;ll also want to install
<a href="http://drupal.org/project/migrate">Migrate</a>, and <a href="http://drupal.org/project/migrate_extras">Migrate Extras</a> if you want to do any work
with CCK fields. I must admit that I hadn&rsquo;t seen Table Wizard before this
project, but it will always be present in my dev installs from here out. If
you find yourself using SQLYog, PHPMyAdmin, or some other tool to simply look
at data in the database, be sure to check it out.</p>

<h2>Create Our Custom Module</h2>

<p>As I mentioned above, we are relying on the Drupal Schema API to make a lot of
this easy, so let&rsquo;s make a custom module that sets up our schemas for us.
We&rsquo;ll call this module my_import. Create a new directory in your modules
directory, and name it my_import. First, create my_import.info with this
inside:</p>

<div class="highlight"><pre><code class="language-ini" data-lang="ini"><span class="na">name</span> <span class="o">=</span> <span class="s">My Import</span>
<span class="na">description</span> <span class="o">=</span> <span class="s">&quot;An import module.&quot;</span>
<span class="na">core</span> <span class="o">=</span> <span class="s">6.x</span>
<span class="na">dependencies[]</span> <span class="o">=</span> <span class="s">migrate</span>
<span class="na">dependencies[]</span> <span class="o">=</span> <span class="s">migrate_extras</span>
<span class="na">dependencies[]</span> <span class="o">=</span> <span class="s">content</span>
<span class="na">dependencies[]</span> <span class="o">=</span> <span class="s">path_redirect</span>
<span class="na">package</span> <span class="o">=</span> <span class="s">Database</span></code></pre></div>


<p>Nothing too wild here, just requiring some modules that we&rsquo;ll
be using later. Now, create my_import.install in the same directory with this
inside:</p>

<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">function</span> <span class="nf">my_import_schema</span><span class="p">()</span> <span class="p">{</span>
  <span class="nv">$schema</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
  
  <span class="nv">$schema</span><span class="p">[</span><span class="s1">&#39;clickability_articles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;fields&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
      <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;int&#39;</span><span class="p">,</span>
        <span class="s1">&#39;not null&#39;</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Clickability article ID&#39;</span><span class="p">),</span>
      <span class="p">),</span>
      <span class="s1">&#39;createDate&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;datetime&#39;</span><span class="p">,</span>
        <span class="s1">&#39;not null&#39;</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Clickability article creation date.&#39;</span><span class="p">),</span>
      <span class="p">),</span>
      <span class="s1">&#39;editDate&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;datetime&#39;</span><span class="p">,</span>
        <span class="s1">&#39;not null&#39;</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Clickability article edit date&#39;</span><span class="p">),</span>
      <span class="p">),</span>
      <span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
        <span class="s1">&#39;not null&#39;</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Clickability article title&#39;</span><span class="p">),</span>
      <span class="p">),</span>
      <span class="s1">&#39;author&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
        <span class="s1">&#39;not null&#39;</span> <span class="o">=&gt;</span> <span class="k">FALSE</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Clickability content author (optional)&#39;</span><span class="p">),</span>
      <span class="p">),</span>
      <span class="s1">&#39;articleauthor&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
        <span class="s1">&#39;not null&#39;</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Clickability article author&#39;</span><span class="p">),</span>
      <span class="p">),</span>
      <span class="s1">&#39;summary&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
        <span class="s1">&#39;not null&#39;</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Clickability article short summary&#39;</span><span class="p">),</span>
      <span class="p">),</span>
      <span class="s1">&#39;body&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
        <span class="s1">&#39;not null&#39;</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">,</span>
        <span class="s1">&#39;size&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;big&#39;</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Clickability article body&#39;</span><span class="p">),</span>
      <span class="p">),</span>
      <span class="s1">&#39;placement&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
        <span class="s1">&#39;not null&#39;</span> <span class="o">=&gt;</span> <span class="k">FALSE</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Clickability article related article placement lists&#39;</span><span class="p">),</span>
      <span class="p">),</span>
      <span class="s1">&#39;thumbnail&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
        <span class="s1">&#39;not null&#39;</span> <span class="o">=&gt;</span> <span class="k">FALSE</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Clickability article thumbnail&#39;</span><span class="p">),</span>
      <span class="p">),</span>
      <span class="s1">&#39;image&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
        <span class="c1">// @todo: Some articles do not have an image, but we require Master Image to be set.</span>
        <span class="s1">&#39;not null&#39;</span> <span class="o">=&gt;</span> <span class="k">FALSE</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Clickability article image&#39;</span><span class="p">),</span>
      <span class="p">),</span>
      <span class="s1">&#39;image2&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
        <span class="s1">&#39;not null&#39;</span> <span class="o">=&gt;</span> <span class="k">FALSE</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Clickability article image page 2&#39;</span><span class="p">),</span>
      <span class="p">),</span>
      <span class="s1">&#39;image3&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
        <span class="s1">&#39;not null&#39;</span> <span class="o">=&gt;</span> <span class="k">FALSE</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Clickability article image page 3&#39;</span><span class="p">),</span>
      <span class="p">),</span>
      <span class="s1">&#39;master_image_byline_title&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
        <span class="s1">&#39;not null&#39;</span> <span class="o">=&gt;</span> <span class="k">FALSE</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Clickability article image page 7&#39;</span><span class="p">),</span>
      <span class="p">),</span>
      <span class="s1">&#39;tags&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
        <span class="s1">&#39;not null&#39;</span> <span class="o">=&gt;</span> <span class="k">FALSE</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Clickability article image page 7&#39;</span><span class="p">),</span>
      <span class="p">),</span>
      <span class="s1">&#39;status&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
        <span class="s1">&#39;not null&#39;</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Clickability article status&#39;</span><span class="p">),</span>
      <span class="p">),</span>
      <span class="s1">&#39;websitePlacements&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
        <span class="s1">&#39;not null&#39;</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span> <span class="o">=&gt;</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Clickability book review status&#39;</span><span class="p">),</span>
      <span class="p">),</span>
      <span class="p">),</span>
    <span class="s1">&#39;primary key&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span>
  <span class="p">);</span>
  <span class="k">return</span> <span class="nv">$schema</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">my_import_install</span><span class="p">()</span> <span class="p">{</span>
  <span class="nv">$ret</span> <span class="o">=</span> <span class="nx">drupal_install_schema</span><span class="p">(</span><span class="s1">&#39;my_import&#39;</span><span class="p">);</span>
  <span class="k">return</span> <span class="nv">$ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">my_import_uninstall</span><span class="p">()</span> <span class="p">{</span>
  <span class="nv">$ret</span> <span class="o">=</span> <span class="nx">drupal_uninstall_schema</span><span class="p">(</span><span class="s1">&#39;my_import&#39;</span><span class="p">);</span>
  <span class="k">return</span> <span class="nv">$ret</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>


<p>When I created the schema, I took care to make sure
that the column names in my table exactly matched the attributes and elements
I was looking to pull out of the XML file. This saves a lot of coding later.
Any time we change the schema, you can create a hook_update_N() function, or
just change the schema and disable+uninstall+install the custom module. I did
the latter with a drush alias and it worked well. The hook_install() and
hook_uninstall() functions simply add and remove the tables.</p>

<h2>Setup the Command Line Script to Import the XML into the DB</h2>

<p>Create the file myimport.php in your module directory, and paste in the
following:</p>

<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">#!/usr/bin/php</span>
<span class="cp">&lt;?php</span>
<span class="c1">// get the path to our XML file</span>
<span class="nv">$args</span> <span class="o">=</span> <span class="nb">getopt</span><span class="p">(</span><span class="s2">&quot;f:&quot;</span><span class="p">);</span>

<span class="c1">// Bootstrap Drupal</span>
<span class="k">require_once</span> <span class="s1">&#39;./includes/bootstrap.inc&#39;</span><span class="p">;</span>
<span class="nx">drupal_bootstrap</span><span class="p">(</span><span class="nx">DRUPAL_BOOTSTRAP_FULL</span><span class="p">);</span>

<span class="c1">// Make sure my_import is enabled</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">module_exists</span><span class="p">(</span><span class="s1">&#39;my_import&#39;</span><span class="p">))</span> <span class="p">{</span> 
  <span class="k">echo</span> <span class="s2">&quot;I need the my_import module enabled!  Exiting.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
  <span class="k">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Make sure our media directory exists.</span>
<span class="cm"> * We will import from this directory into whatever directory filefield is configured for</span>
<span class="cm"> * so we should remove this dir when done with the migration.</span>
<span class="cm"> */</span>
<span class="nv">$media_dir</span> <span class="o">=</span> <span class="nx">file_directory_path</span><span class="p">()</span> <span class="o">.</span><span class="s1">&#39;/migrated&#39;</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">&quot;Media dir = </span><span class="si">$media_dir\n</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">is_dir</span><span class="p">(</span><span class="nv">$media_dir</span><span class="p">))</span> <span class="p">{</span>
  <span class="nb">mkdir</span><span class="p">(</span><span class="nv">$media_dir</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Slurp in our XML file.  If your XML file is huge, watch your PHP memory limits</span>
<span class="nv">$xml</span> <span class="o">=</span> <span class="nb">simplexml_load_file</span><span class="p">(</span><span class="nv">$args</span><span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">]);</span>
<span class="k">echo</span> <span class="s2">&quot;XML Loaded.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>

<span class="nv">$rowcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="c1">// Here we iterate over each child of the root of the XML, which in our case is a Article</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$xml</span><span class="o">-&gt;</span><span class="na">children</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$content</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Setup our $obj object which represents a row in the DB, and use some caching to </span>
  <span class="c1">// not abuse drupal_get_schema().</span>
  <span class="nv">$obj</span> <span class="o">=</span> <span class="k">new</span> <span class="k">stdClass</span><span class="p">;</span>
  <span class="k">static</span> <span class="nv">$schema</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
  
  <span class="c1">// Dereference our child from the parent $xml, or xpath performance sucks hard</span>
  <span class="nv">$content</span> <span class="o">=</span> <span class="nb">simplexml_load_string</span><span class="p">(</span><span class="nv">$content</span><span class="o">-&gt;</span><span class="na">asXML</span><span class="p">());</span>
  
  <span class="nv">$table</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span>
  <span class="nv">$content_type</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span>
  <span class="k">switch</span><span class="p">((</span><span class="nx">string</span><span class="p">)</span> <span class="nv">$content</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">])</span> <span class="p">{</span> 
    <span class="c1">// Add more case statements for more content types as needed</span>
    <span class="k">case</span> <span class="s1">&#39;Article&#39;</span><span class="o">:</span>
      <span class="nv">$table</span> <span class="o">=</span> <span class="s1">&#39;clickability_articles&#39;</span><span class="p">;</span>
      <span class="nv">$content_type</span> <span class="o">=</span> <span class="s1">&#39;article&#39;</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="c1">// All cases below are silently ignored - we are not importing them</span>
    <span class="k">case</span> <span class="s1">&#39;Book Reviews&#39;</span><span class="o">:</span>
    <span class="k">case</span> <span class="s1">&#39;Blog Topic&#39;</span><span class="o">:</span>
    <span class="k">case</span> <span class="s1">&#39;Event&#39;</span><span class="o">:</span>
    <span class="k">case</span> <span class="s1">&#39;Job&#39;</span><span class="o">:</span> 
      <span class="c1">// Ignored</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">default</span><span class="o">:</span>
      <span class="c1">// Any content type not accounted for gets reported</span>
      <span class="k">echo</span> <span class="s2">&quot;Warning: unknown content of type &quot;</span><span class="o">.</span> <span class="nv">$content</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$table</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$schema</span><span class="p">[</span><span class="nv">$table</span><span class="p">]))</span> <span class="p">{</span>
      <span class="c1">// Get the table schema from Drupal</span>
      <span class="nv">$schema</span><span class="p">[</span><span class="nv">$table</span><span class="p">]</span> <span class="o">=</span> <span class="nx">drupal_get_schema</span><span class="p">(</span><span class="nv">$table</span><span class="p">);</span>
      <span class="c1">// On first run, truncate the table</span>
      <span class="nv">$sql</span> <span class="o">=</span> <span class="s2">&quot;truncate table </span><span class="si">{</span><span class="nv">$table</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span>
      <span class="nx">db_query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
      <span class="k">echo</span> <span class="s2">&quot;</span><span class="si">$table</span><span class="s2"> truncated.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// This function does the heavy lifting, creating the $obj object from the XML data</span>
    <span class="nv">$obj</span> <span class="o">=</span> <span class="nx">xml2object</span><span class="p">(</span><span class="nv">$content</span><span class="p">,</span> <span class="nv">$schema</span><span class="p">[</span><span class="nv">$table</span><span class="p">],</span> <span class="nv">$content</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]);</span> 
    <span class="c1">// There are some cases where $obj is intentionally null, only write to the db if not null</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$obj</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$ret</span> <span class="o">=</span> <span class="nx">drupal_write_record</span><span class="p">(</span><span class="nv">$table</span><span class="p">,</span> <span class="nv">$obj</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nv">$ret</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$rowcount</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="k">echo</span> <span class="s2">&quot;Inserted </span><span class="si">$rowcount</span><span class="s2"> rows.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>

<span class="k">function</span> <span class="nf">xml2object</span><span class="p">(</span><span class="nv">$xml</span><span class="p">,</span> <span class="nv">$tableschema</span><span class="p">,</span> <span class="nv">$content_type</span><span class="p">)</span> <span class="p">{</span>
  
  <span class="k">global</span> <span class="nv">$media_dir</span><span class="p">;</span>
  <span class="nv">$obj</span> <span class="o">=</span> <span class="k">new</span> <span class="k">stdClass</span><span class="p">;</span>
  <span class="c1">// Our main iterator is the column names in the table</span>
  <span class="k">foreach</span> <span class="p">(</span><span class="nb">array_keys</span><span class="p">(</span><span class="nv">$tableschema</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">])</span> <span class="k">as</span> <span class="nv">$field</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span><span class="p">(</span><span class="nv">$field</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="s1">&#39;master_image_byline_title&#39;</span><span class="o">:</span>
        <span class="c1">// This field is populated when we work with the images later on</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;id&#39;</span><span class="o">:</span>
        <span class="nv">$obj</span><span class="o">-&gt;</span><span class="nv">$field</span> <span class="o">=</span> <span class="nv">$xml</span><span class="p">[</span><span class="nv">$field</span><span class="p">];</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;status&#39;</span><span class="o">:</span>
        <span class="nv">$obj</span><span class="o">-&gt;</span><span class="nv">$field</span> <span class="o">=</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span><span class="nv">$xml</span><span class="o">-&gt;</span><span class="nv">$field</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="c1">// A Clickability placement roughly corresponds to a Drupal term</span>
      <span class="k">case</span> <span class="s1">&#39;placement&#39;</span><span class="o">:</span>
        <span class="nv">$element</span> <span class="o">=</span>  <span class="nb">array_pop</span><span class="p">(</span><span class="nv">$xml</span><span class="o">-&gt;</span><span class="na">xpath</span><span class="p">(</span><span class="s2">&quot;//field[@name=&#39;</span><span class="si">$field</span><span class="s2">&#39;]&quot;</span><span class="p">));</span>
        <span class="nv">$obj</span><span class="o">-&gt;</span><span class="nv">$field</span> <span class="o">=</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span><span class="nv">$element</span><span class="o">-&gt;</span><span class="na">row</span><span class="o">-&gt;</span><span class="na">value</span><span class="p">;</span>
        <span class="nv">$obj</span><span class="o">-&gt;</span><span class="nv">$field</span> <span class="o">=</span> <span class="nx">map_taxonomy</span><span class="p">(</span><span class="nv">$obj</span><span class="o">-&gt;</span><span class="nv">$field</span><span class="p">,</span> <span class="nv">$content_type</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;author&#39;</span><span class="o">:</span>
        <span class="nv">$element</span> <span class="o">=</span>  <span class="nb">array_pop</span><span class="p">(</span><span class="nv">$xml</span><span class="o">-&gt;</span><span class="na">xpath</span><span class="p">(</span><span class="s2">&quot;//field[@name=&#39;</span><span class="si">$field</span><span class="s2">&#39;]&quot;</span><span class="p">));</span>
        <span class="nv">$obj</span><span class="o">-&gt;</span><span class="nv">$field</span> <span class="o">=</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span><span class="nv">$element</span><span class="o">-&gt;</span><span class="na">value</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;image2&#39;</span><span class="o">:</span>
      <span class="k">case</span> <span class="s1">&#39;image3&#39;</span><span class="o">:</span>
        <span class="c1">// Combine image2 and image3 elements in Clickability into our multivalue filefield as csv</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$content_type</span> <span class="o">==</span> <span class="s2">&quot;Article&quot;</span><span class="p">)</span> <span class="p">{</span>
          <span class="nv">$mediaplacement</span> <span class="o">=</span> <span class="nb">array_pop</span><span class="p">(</span><span class="nv">$xml</span><span class="o">-&gt;</span><span class="na">xpath</span><span class="p">(</span><span class="s2">&quot;//mediaPlacement[@name=&#39;</span><span class="si">$field</span><span class="s2">&#39;]&quot;</span><span class="p">));</span>
          <span class="c1">// migrate module requires full path to filefield source</span>
          <span class="nv">$obj</span><span class="o">-&gt;</span><span class="nv">$field</span> <span class="o">=</span> <span class="nb">getcwd</span><span class="p">()</span> <span class="o">.</span><span class="s1">&#39;/&#39;</span><span class="o">.</span> <span class="nv">$media_dir</span> <span class="o">.</span><span class="s1">&#39;/&#39;</span><span class="o">.</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span><span class="nv">$mediaplacement</span><span class="o">-&gt;</span><span class="na">media</span><span class="o">-&gt;</span><span class="na">path</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nb">substr</span><span class="p">(</span><span class="nv">$obj</span><span class="o">-&gt;</span><span class="nv">$field</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>  <span class="p">{</span>
            <span class="nv">$obj</span><span class="o">-&gt;</span><span class="nv">$field</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$obj</span><span class="o">-&gt;</span><span class="na">image</span><span class="p">))</span> <span class="p">{</span>
              <span class="nv">$obj</span><span class="o">-&gt;</span><span class="na">image</span> <span class="o">.=</span> <span class="s2">&quot;,&quot;</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nv">$obj</span><span class="o">-&gt;</span><span class="na">image</span> <span class="o">.=</span> <span class="nv">$obj</span><span class="o">-&gt;</span><span class="nv">$field</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;thumbnail&#39;</span><span class="o">:</span>
      <span class="k">case</span> <span class="s1">&#39;image&#39;</span><span class="o">:</span>
        <span class="nv">$mediaplacement</span> <span class="o">=</span> <span class="nb">array_pop</span><span class="p">(</span><span class="nv">$xml</span><span class="o">-&gt;</span><span class="na">xpath</span><span class="p">(</span><span class="s2">&quot;//mediaPlacement[@name=&#39;</span><span class="si">$field</span><span class="s2">&#39;]&quot;</span><span class="p">));</span>
        <span class="c1">// migrate module requires full path to filefield source</span>
        <span class="nv">$obj</span><span class="o">-&gt;</span><span class="nv">$field</span> <span class="o">=</span> <span class="nb">getcwd</span><span class="p">()</span> <span class="o">.</span><span class="s1">&#39;/&#39;</span><span class="o">.</span> <span class="nv">$media_dir</span> <span class="o">.</span><span class="s1">&#39;/&#39;</span><span class="o">.</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span><span class="nv">$mediaplacement</span><span class="o">-&gt;</span><span class="na">media</span><span class="o">-&gt;</span><span class="na">path</span><span class="p">;</span>
        <span class="c1">// Check the schema.  If the field is required, then fill in a default, otherwise wipe it</span>
        <span class="nv">$required</span> <span class="o">=</span> <span class="nv">$tableschema</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="nv">$field</span><span class="p">][</span><span class="s1">&#39;not null&#39;</span><span class="p">];</span>
        <span class="c1">// If the file path ends in a /, then the XML did not have an image for this article</span>
        <span class="c1">// -- if we require one, make a default</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">substr</span><span class="p">(</span><span class="nv">$obj</span><span class="o">-&gt;</span><span class="nv">$field</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>  <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nv">$required</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">echo</span> <span class="s2">&quot;</span><span class="si">$content_type</span><span class="s2"> with ID of &quot;</span><span class="o">.</span> <span class="nv">$obj</span><span class="o">-&gt;</span><span class="na">id</span> <span class="o">.</span><span class="s2">&quot; does not have a </span><span class="si">$field</span><span class="s2">.  Adding test.gif.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
            <span class="nv">$obj</span><span class="o">-&gt;</span><span class="nv">$field</span> <span class="o">.=</span> <span class="s2">&quot;test.gif&quot;</span><span class="p">;</span>
            <span class="nb">touch</span><span class="p">(</span><span class="nv">$obj</span><span class="o">-&gt;</span><span class="nv">$field</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// NOTE: We need this patch for this to work: http://drupal.org/node/780920</span>
            <span class="nv">$obj</span><span class="o">-&gt;</span><span class="nv">$field</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="c1">// Transfer the caption on the image in the XML to the CCK byline accreditation</span>
          <span class="nv">$obj</span><span class="o">-&gt;</span><span class="na">master_image_byline_title</span> <span class="o">=</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span><span class="nv">$mediaplacement</span><span class="o">-&gt;</span><span class="na">caption</span><span class="p">;</span>
          <span class="c1">// See if the file exists on the filesystem</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">file_exists</span><span class="p">(</span><span class="nv">$obj</span><span class="o">-&gt;</span><span class="nv">$field</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// Nope, let&#39;s fill it in with our default image</span>
            <span class="k">echo</span> <span class="nv">$obj</span><span class="o">-&gt;</span><span class="nv">$field</span> <span class="o">.</span><span class="s2">&quot; does not exist, replacing with test.gif.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
            <span class="nv">$obj</span><span class="o">-&gt;</span><span class="nv">$field</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">&#39;#^(.*)/(.*)$#&#39;</span><span class="p">,</span> <span class="s1">&#39;\1/test.gif&#39;</span><span class="p">,</span> <span class="nv">$obj</span><span class="o">-&gt;</span><span class="nv">$field</span><span class="p">);</span>
          <span class="p">}</span>
          
          <span class="c1">// Replace .bmp with .jpg</span>
          <span class="nv">$jpg</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">&#39;/\.bmp$/&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpg&#39;</span><span class="p">,</span> <span class="nv">$obj</span><span class="o">-&gt;</span><span class="nv">$field</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nv">$jpg</span> <span class="o">!=</span> <span class="nv">$obj</span><span class="o">-&gt;</span><span class="nv">$field</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$jpg</span><span class="p">))</span> <span class="p">{</span>
              <span class="nv">$obj</span><span class="o">-&gt;</span><span class="nv">$field</span> <span class="o">=</span> <span class="nv">$jpg</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
              <span class="c1">// Tell the user what to do to create the image and exit.</span>
              <span class="k">echo</span> <span class="s2">&quot;ID &quot;</span><span class="o">.</span> <span class="nv">$obj</span><span class="o">-&gt;</span><span class="na">id</span> <span class="o">.</span><span class="s2">&quot; has a image of type bmp, and no jpg found on the file system.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
              <span class="k">echo</span> <span class="s2">&quot;Create them by running &#39;mogrify -format jpg /path/to/*.bmp&#39; and re-run this script.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
              <span class="k">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="p">}</span>
            
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="c1">// Any DB column not explicity defined above maps cleanly with the code below</span>
      <span class="k">default</span><span class="o">:</span>
        <span class="nv">$obj</span><span class="o">-&gt;</span><span class="nv">$field</span> <span class="o">=</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span><span class="nb">array_pop</span><span class="p">(</span><span class="nv">$xml</span><span class="o">-&gt;</span><span class="na">xpath</span><span class="p">(</span><span class="s2">&quot;//field[@name=&#39;</span><span class="si">$field</span><span class="s2">&#39;]&quot;</span><span class="p">));</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="p">}</span>
  
  <span class="c1">// We assume it does not need imported until we prove otherwise</span>
  <span class="nv">$needs_imported</span> <span class="o">=</span> <span class="k">FALSE</span><span class="p">;</span>
  <span class="nv">$tags</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
  <span class="nv">$websitePlacements</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
  <span class="k">foreach</span> <span class="p">(</span><span class="nv">$xml</span><span class="o">-&gt;</span><span class="na">xpath</span><span class="p">(</span><span class="s2">&quot;//websitePlacement&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$websitePlacement</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Only if the XML says the domain is www.newdomain.com do we need to import</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$websitePlacement</span><span class="o">-&gt;</span><span class="na">domain</span> <span class="o">==</span> <span class="s1">&#39;www.newdomain.com&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$needs_imported</span> <span class="o">=</span> <span class="k">TRUE</span><span class="p">;</span>
      
      <span class="c1">// Convert the old &quot;sections&quot; into tag taxonomy</span>
      <span class="nv">$tags</span><span class="p">[]</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$section</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$section</span><span class="p">));</span>
      
      <span class="c1">// Grab the old URLs from websitePlacement, and place them on an array</span>
      <span class="nv">$section</span> <span class="o">=</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span><span class="nv">$websitePlacement</span><span class="o">-&gt;</span><span class="na">section</span><span class="p">;</span>
      <span class="nv">$oldurl</span> <span class="o">=</span> <span class="nv">$section</span> <span class="o">.</span><span class="s1">&#39;/&#39;</span><span class="o">.</span> <span class="nv">$obj</span><span class="o">-&gt;</span><span class="na">id</span> <span class="o">.</span><span class="s1">&#39;.html&#39;</span><span class="p">;</span>
      <span class="nv">$websitePlacements</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$oldurl</span><span class="p">;</span>
      
      <span class="c1">// If we do not have a placement yet, we try to set some form of taxonomy</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$obj</span><span class="o">-&gt;</span><span class="na">placement</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$taxo</span> <span class="o">=</span> <span class="nx">map_taxonomy</span><span class="p">(</span><span class="nv">$section</span><span class="p">,</span> <span class="nv">$content_type</span><span class="p">);</span>
        <span class="c1">// NOTE: We need this patch for this to work: http://drupal.org/node/780920</span>
        <span class="nv">$obj</span><span class="o">-&gt;</span><span class="na">placement</span> <span class="o">=</span> <span class="nv">$taxo</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="c1">// If the XML did not explicity tell us the createDate, we use the start date from the webSitePlacement</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$obj</span><span class="o">-&gt;</span><span class="na">createDate</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$date</span> <span class="o">=</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span><span class="nv">$websitePlacement</span><span class="o">-&gt;</span><span class="na">startDate</span><span class="p">;</span>
        <span class="nv">$obj</span><span class="o">-&gt;</span><span class="na">createDate</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$date</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$date</span><span class="p">)</span> <span class="o">-</span><span class="mi">4</span><span class="p">);</span>
        <span class="nv">$obj</span><span class="o">-&gt;</span><span class="na">editDate</span> <span class="o">=</span> <span class="nv">$obj</span><span class="o">-&gt;</span><span class="na">createDate</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>    
  <span class="p">}</span>
  <span class="nv">$obj</span><span class="o">-&gt;</span><span class="na">websitePlacements</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="nv">$websitePlacements</span><span class="p">);</span>
  <span class="nv">$obj</span><span class="o">-&gt;</span><span class="na">tags</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="nv">$tags</span><span class="p">);</span>
  
  <span class="c1">// Return the object only if we need it imported</span>
  <span class="k">return</span> <span class="nv">$needs_imported</span> <span class="o">?</span> <span class="nv">$obj</span> <span class="o">:</span> <span class="k">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">map_taxonomy</span><span class="p">(</span><span class="nv">$oldtext</span><span class="p">,</span> <span class="nv">$content_type</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Simple maps of Clickability placements to Drupal terms</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$content_type</span> <span class="o">==</span> <span class="s1">&#39;Job&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">NULL</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">&#39;/building/i&#39;</span><span class="p">,</span> <span class="nv">$oldtext</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">&quot;Green Building&quot;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">&#39;/(clean|energy)/i&#39;</span><span class="p">,</span> <span class="nv">$oldtext</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">&quot;Clean Energy&quot;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">&#39;/financ/i&#39;</span><span class="p">,</span> <span class="nv">$oldtext</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">&quot;Finance&quot;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">&#39;/food/i&#39;</span><span class="p">,</span> <span class="nv">$oldtext</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">&quot;Food &amp; Farms&quot;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">&#39;/marketing/i&#39;</span><span class="p">,</span> <span class="nv">$oldtext</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">&quot;Green Marketing&quot;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">&#39;/recycled/i&#39;</span><span class="p">,</span> <span class="nv">$oldtext</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">&quot;Recycled Markets&quot;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">&#39;/technol/i&#39;</span><span class="p">,</span> <span class="nv">$oldtext</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">&quot;Technology&quot;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">&#39;/leaders/i&#39;</span><span class="p">,</span> <span class="nv">$oldtext</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">&quot;Business Leaders&quot;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">&#39;/transportation/i&#39;</span><span class="p">,</span> <span class="nv">$oldtext</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">&quot;Transportation&quot;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="k">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">?&gt;</span><span class="x"></span></code></pre></div>


<p>Wow, that&rsquo;s a lot of code. I&rsquo;ve commented
it pretty heavily, but here&rsquo;s the &ldquo;40,000 foot view&rdquo; of what&rsquo;s going on:</p>

<ul>
<li><strong>Lines 1-26:</strong> Nothing too fancy here. I should note that the script expects to be executed from your Drupal root directory. It grabs the path to the XML file from the command line and does some sanity checking.</li>
<li><strong>Lines 28-30:</strong> Here we use PHP&rsquo;s <a href="http://php.net/manual/en/book.simplexml.php">SimpleXML API</a> to load the entire XML file into an object. If you have a huge XML file and/or small PHP memory limits, you will likely have to use XML Parser or another library. The power and convenience of SimpleXML is a pretty convincing argument to temporarily upping your memory limits in this case.</li>
<li><strong>Lines 34-82:</strong> This is the main loop which iterates over each Article in the XML file. By looking at the content type in the XML record, we determine what table and content type to use for Drupal. The first time a schema is loaded, we truncate the table in the database. Once we determine some metadata about the record, we call xml2object() on line 72 which does most of the work for us. Once we have an object, we store it to the database.</li>
<li><strong>Lines 84-222:</strong> Here we have the xml2object() function, and yes, it&rsquo;s way too long and should be broken up. But hey, it&rsquo;s migration code, who else will ever see it??? We&rsquo;ll break it down more below.</li>
<li><strong>Lines 89-182:</strong> This code runs a for loop around each column in the table. Since we&rsquo;re using the Schema API here, we can safely assume that the column order specified in our install file will be duplicated when we fetch it in our script. For each column type in the table, it attempts to pull the data needed from the XML record, transform it if necessary, and store it in our $obj object. Read the code for details on what is happening to each field on the way in.</li>
<li><strong>Lines 184-218:</strong> Now that we have iterated over all the fields in the schema, we can use the data stored in $obj to calculate other fields we need. Again, read the code for details, but here we are setting taxonomy terms, URLs for use with path_redirect, and filling in other data that may have been missing from the XML.</li>
<li><strong>Lines 224-257:</strong> Is a simple example on how to statically map some data in the XML to return taxonomy terms in Drupal
Now that we&rsquo;ve got that out of the way, let&rsquo;s create our module file.</li>
</ul>


<h2>Create my_import.module</h2>

<p>Now, create a file in your module directory named my_import.module. This file
will contain the actual module used by Drupal and will implement some of the
migrate modules hooks. You might ask, why not deal with everything in the
command line script? There are two primary reasons why:</p>

<ol>
<li>You may come across a condition where you need the nid of the node (i.e. create path redirects), or otherwise interact with the $node object. You can only get this information from implementing migrate&rsquo;s hooks.</li>
<li>While I personally found it easier to manipulate taxonomy terms via the command line script and then rely upon the out-of-the-box code supplied with migrate to setup the node for me, this has a drawback. Any time you change the command line script, you must &ldquo;clear&rdquo; your imported data, re-run the command line script, and re-import your data using the migrate module. If you make changes to your module, you only have two steps to test (clear and re-import).
Paste this code into my_import.module:</li>
</ol>


<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nb">define</span><span class="p">(</span><span class="nx">NUM_PARAGRAPHS_PER_PAGE</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

<span class="k">function</span> <span class="nf">my_import_migrate_prepare_user</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$user</span><span class="p">,</span> <span class="nv">$tblinfo</span><span class="p">,</span> <span class="nv">$row</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Randomly assign passwords to users, forcing them to reset their password</span>
  <span class="nv">$errors</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
  <span class="nv">$user</span><span class="p">[</span><span class="s1">&#39;pass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s2">&quot;/([0-9])/e&quot;</span><span class="p">,</span><span class="s2">&quot;chr((</span><span class="se">\\</span><span class="s2">1+112))&quot;</span><span class="p">,</span><span class="nb">rand</span><span class="p">(</span><span class="mi">100000</span><span class="p">,</span><span class="mi">999999</span><span class="p">));</span>
  <span class="k">return</span> <span class="nv">$errors</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">my_import_migrate_prepare_node</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$node</span><span class="p">,</span> <span class="nv">$tblinfo</span><span class="p">,</span> <span class="nv">$row</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$errors</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
  <span class="c1">// In Clickability, there were multiple states that represented &quot;Published&quot;, here we map them.</span>
  <span class="nv">$status</span> <span class="o">=</span> <span class="nv">$tblinfo</span><span class="o">-&gt;</span><span class="na">view_name</span> <span class="o">.</span><span class="s1">&#39;_status&#39;</span><span class="p">;</span>
  <span class="k">switch</span><span class="p">(</span><span class="nv">$row</span><span class="o">-&gt;</span><span class="nv">$status</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="s1">&#39;live&#39;</span><span class="o">:</span>
    <span class="k">case</span> <span class="s1">&#39;APPROVED&#39;</span><span class="o">:</span>
      <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">default</span><span class="o">:</span>
      <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span> 
  
  <span class="k">if</span> <span class="p">(</span><span class="nv">$node</span><span class="o">-&gt;</span><span class="na">type</span> <span class="o">==</span> <span class="s1">&#39;article&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Paginate articles by inserting a pagebreak tag every 6th paragraph to emulate Clickability&#39;s pagination</span>
    <span class="nv">$paragraphs</span> <span class="o">=</span> <span class="nb">preg_split</span><span class="p">(</span><span class="s1">&#39;#&lt;br /&gt;\s*&lt;br /&gt;#s&#39;</span><span class="p">,</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">body</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$paragraphs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nx">NUM_PARAGRAPHS_PER_PAGE</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">body</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="nv">$i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">foreach</span> <span class="p">(</span><span class="nv">$paragraphs</span> <span class="k">as</span> <span class="nv">$paragraph</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="nv">$i</span> <span class="o">%</span> <span class="nx">NUM_PARAGRAPHS_PER_PAGE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">body</span> <span class="o">.=</span> <span class="nv">$paragraph</span> <span class="o">.</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[pagebreak]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">body</span> <span class="o">.=</span> <span class="nv">$paragraph</span> <span class="o">.</span><span class="s2">&quot;&lt;br /&gt;</span><span class="se">\n</span><span class="s2">&lt;br /&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$i</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    
  <span class="p">}</span>
  <span class="k">return</span> <span class="nv">$errors</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">my_import_migrate_complete_node</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$node</span><span class="p">,</span> <span class="nv">$tblinfo</span><span class="p">,</span> <span class="nv">$row</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$errors</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
  <span class="c1">// Create redirects for old URLs</span>
  <span class="nv">$field</span> <span class="o">=</span> <span class="nv">$tblinfo</span><span class="o">-&gt;</span><span class="na">view_name</span> <span class="o">.</span><span class="s1">&#39;_websitePlacements&#39;</span><span class="p">;</span>
  <span class="k">foreach</span><span class="p">(</span><span class="nb">explode</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="nv">$row</span><span class="o">-&gt;</span><span class="nv">$field</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$oldurl</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Delete any old redirects</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">substr</span><span class="p">(</span><span class="nv">$oldurl</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$oldurl</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$oldurl</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">path_redirect_delete</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;source&#39;</span> <span class="o">=&gt;</span> <span class="nv">$oldurl</span><span class="p">));</span>
    <span class="nv">$redirect</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
      <span class="s1">&#39;source&#39;</span> <span class="o">=&gt;</span> <span class="nv">$oldurl</span><span class="p">,</span>
      <span class="s1">&#39;redirect&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;/node/&#39;</span><span class="o">.</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">nid</span><span class="p">,</span>
      <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="mi">301</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="nx">path_redirect_save</span><span class="p">(</span><span class="nv">$redirect</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nv">$errors</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>


<p>Here&rsquo;s the high-level breakdown, check the code+comments for
the details.</p>

<ul>
<li><strong>Lines 5-10:</strong> Just a quick example of how to set a random password on any user that is imported.</li>
<li><strong>Lines 12-24:</strong> hook_migrate_prepare_node() is executed before the node has been saved to the database, and should be where the majority of your code is at. These lines set any article with a status of &lsquo;live&rsquo; or &lsquo;APPROVED&rsquo; to published in Drupal.</li>
<li><strong>Lines 26-41:</strong> This code uses some regex magic to create a pagebreak every 6th paragraph. This is what Clickability did, and the client wanted to keep this on their migrated articles.</li>
<li><strong>Lines 47-65:</strong> hook_migrate_complete_node() is called after the node has been saved to the database, and it has a nid at this point. The client wished to migrate their old URL&rsquo;s to Drupal &ndash; in order to do that we must have the nid to know where to redirect to.</li>
</ul>


<h2>Create sample XML</h2>

<p>Finally, let&rsquo;s create some sample data so we can see how this all meshes
together. Create the file content.xml in your module directory, and paste this
in it:</p>

<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;cmPublishImport&gt;</span>
  <span class="nt">&lt;content</span> <span class="na">type=</span><span class="s">&quot;Article&quot;</span> <span class="na">id=</span><span class="s">&quot;7241321&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;title&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;![CDATA[Donec risus purus]]&gt;</span><span class="nt">&lt;/field&gt;</span>
    <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;author&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;value&gt;</span><span class="cp">&lt;![CDATA[Me]]&gt;</span><span class="nt">&lt;/value&gt;</span>
    <span class="nt">&lt;/field&gt;</span>
    <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;articleauthor&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;![CDATA[Me]]&gt;</span><span class="nt">&lt;/field&gt;</span>
    <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;date&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;![CDATA[2007-04-29]]&gt;</span><span class="nt">&lt;/field&gt;</span>
    <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;summary&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;![CDATA[Donec risus purus]]&gt;</span><span class="nt">&lt;/field&gt;</span>
    <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;body&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;![CDATA[Donec risus purus, euismod eu volutpat ac, pharetra non nulla. Vestibulum quis neque lacus. Donec sit amet tortor nisi. Nam et lectus nec turpis consequat rhoncus. Proin porttitor, quam nec faucibus pulvinar, arcu magna facilisis erat, eu imperdiet risus tortor ac quam. Praesent non justo ac nisl ultricies condimentum a eget arcu. Nam in mi est. Donec risus orci, imperdiet ut tempus et, pulvinar nec diam. Donec eleifend pulvinar aliquam. Nulla faucibus turpis nec neque scelerisque convallis. Fusce gravida pulvinar quam, sit amet faucibus risus sodales ornare. Nullam arcu risus, lacinia vel faucibus at, auctor eget diam. Quisque a neque ac tellus bibendum luctus fringilla in lacus. Praesent id nunc eu dolor adipiscing consequat vel eget leo. Donec velit mi, pharetra quis tincidunt id, laoreet et dolor. Vestibulum fringilla rutrum arcu at accumsan.&lt;br/&gt;</span>
<span class="cp">&lt;br/&gt;  </span>
<span class="cp">Cras pellentesque sagittis mi. Pellentesque cursus nisl id nunc suscipit luctus. Duis pellentesque rhoncus sodales. Nullam dictum augue ac diam fermentum vel feugiat mauris euismod. Mauris nec metus eu sem tristique euismod. Etiam lorem est, accumsan vitae bibendum sit amet, tempus sit amet urna. Nullam lobortis adipiscing convallis. Nullam scelerisque sagittis tellus vitae interdum. Integer eget interdum nunc. Nam ligula orci, bibendum ac mattis eget, mollis at massa.&lt;br/&gt;</span>
<span class="cp">&lt;br/&gt;  </span>
<span class="cp">Vestibulum sodales elit vel est feugiat vitae dapibus erat ultricies. Proin auctor quam sit amet nisi aliquet pharetra. Curabitur tristique quam vel tortor gravida scelerisque. Morbi laoreet aliquet mi, sed imperdiet mauris mattis et. Praesent non quam nec lorem dapibus semper. Quisque vulputate neque et turpis placerat bibendum. Phasellus suscipit urna eget augue ullamcorper ultricies. Curabitur hendrerit dui sit amet elit elementum nec venenatis orci tempor. Fusce semper vestibulum odio vitae porta. Mauris non tellus non mi hendrerit suscipit in sed ante. Donec arcu neque, tristique ut elementum sed, suscipit at leo. Curabitur eget enim quis leo scelerisque laoreet et eget augue. Fusce posuere est ac felis fringilla consectetur. Nulla elit magna, pharetra sit amet tincidunt sed, tristique sed mi. Nam iaculis, elit sit amet condimentum blandit, massa neque pharetra justo, non ornare ligula ante non leo. Praesent ullamcorper suscipit tempus. In varius, neque eget volutpat posuere, velit odio luctus turpis, ac varius nulla erat sit amet justo. Quisque convallis mollis pharetra. Aliquam porta dolor quis nunc tempor vitae pharetra lectus ultricies. Fusce egestas sagittis sapien, sit amet pharetra sem ullamcorper a.&lt;br/&gt;</span>
<span class="cp">&lt;br/&gt;  </span>
<span class="cp">Ut dui tortor, porta eu ultrices sed, interdum vitae lectus. Integer facilisis velit sit amet dui ultricies lobortis. Fusce ut malesuada tellus. Aenean in nibh at lorem iaculis dictum vitae in nulla. Etiam dapibus lacinia eleifend. Aliquam erat volutpat. Nullam sit amet sapien ut risus consequat posuere eu quis quam. In lobortis fringilla felis quis pretium. Suspendisse non nisl libero, non tempor justo. Nunc volutpat nulla vitae lacus tincidunt feugiat congue sapien commodo. Suspendisse venenatis aliquet ante in hendrerit. Sed lectus ligula, gravida id tincidunt et, feugiat non justo.&lt;br/&gt;</span>
<span class="cp">&lt;br/&gt;  </span>
<span class="cp">Sed metus tellus, vestibulum in mollis quis, imperdiet et velit. Praesent suscipit elit et mi rutrum sit amet gravida augue iaculis. Etiam nec tellus nec augue porttitor pharetra. Vivamus feugiat mollis est, eu aliquam neque tempus a. Ut magna mauris, sollicitudin in ornare non, lacinia a lacus. Aenean porttitor magna ac sem ornare pellentesque. Aliquam mattis dolor in metus molestie ut feugiat mi auctor. Etiam laoreet pulvinar ipsum id bibendum. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. Quisque porttitor convallis lacus, nec pretium leo varius non. Morbi non dapibus diam. Sed nec venenatis diam. Cras mollis porta tempor.&lt;br/&gt;</span>
<span class="cp">&lt;br/&gt;  </span>
<span class="cp">Donec ornare mi sed tellus porta luctus. Nulla euismod venenatis ante, in rhoncus felis ornare non. Cras tempor venenatis est at gravida. Etiam imperdiet dolor vitae ipsum lacinia imperdiet. Maecenas purus lorem, rhoncus non porttitor in, semper nec quam. Integer ullamcorper facilisis ultrices. Vivamus porttitor lacinia augue in venenatis. Quisque interdum euismod tellus, et consectetur nunc dictum sit amet. Maecenas pulvinar placerat mauris, quis auctor purus pellentesque at. Vestibulum vulputate, tellus id eleifend posuere, ligula erat hendrerit orci, nec lobortis tortor sapien ut ligula. Donec id augue leo, non consectetur nisl. In viverra dictum lorem eget blandit. Etiam tempus nisl ac nibh viverra id cursus eros luctus. Duis ut tellus nisi.&lt;br/&gt;</span>
<span class="cp">&lt;br/&gt;  </span>
<span class="cp">Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. Aliquam quis justo risus, eget eleifend nibh. Morbi quis dolor nulla, sed cursus metus. Vestibulum vel ipsum non erat tincidunt luctus et eget sapien. Nunc vel justo ante, vel auctor purus. Proin vulputate bibendum placerat. Fusce vel tincidunt nunc. Praesent at eros in dolor faucibus blandit et vitae magna. Fusce arcu nisl, sollicitudin sed accumsan sed, rhoncus at tellus. Ut ut mauris vel ipsum bibendum ullamcorper eget sed neque. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. Sed dui massa, imperdiet sit amet lacinia id, rutrum sed orci. Proin pharetra risus eu risus gravida convallis id ac mi. Etiam a neque ut lacus convallis accumsan non eget arcu. Sed blandit velit id lectus tincidunt ut aliquet mi egestas. Aliquam cursus odio vitae turpis suscipit mollis et aliquam purus. Suspendisse pretium tincidunt porttitor. Nunc vestibulum, lacus at auctor laoreet, orci lectus volutpat diam, ut mollis risus lectus a ligula.&lt;br/&gt;</span>
<span class="cp">&lt;br/&gt;  </span>
<span class="cp">Phasellus id urna sit amet elit pretium viverra sit amet eget felis. Maecenas sed arcu sed eros fringilla commodo id non magna. Maecenas urna mauris, cursus vel mattis et, volutpat in purus. Nulla sapien orci, faucibus sed tincidunt tincidunt, tristique id lacus. Nullam tortor libero, porttitor eget faucibus eget, vehicula a enim. Suspendisse malesuada consectetur mattis. Integer dapibus dignissim tempor. In viverra luctus orci sed placerat. Suspendisse aliquam mattis diam mattis dapibus. Aenean suscipit purus eu ipsum dignissim in aliquet urna mollis. Duis nibh magna, fringilla eu ultrices posuere, sodales sed felis. Proin varius dignissim sem a consequat. Pellentesque facilisis felis vel mi malesuada placerat. Curabitur gravida euismod mi in molestie. Vivamus sit amet dui leo. Praesent mi justo, bibendum at rutrum ac, bibendum ut felis. Nullam nec dolor dui, quis imperdiet nulla. Morbi semper pulvinar risus.]]&gt;</span><span class="nt">&lt;/field&gt;</span>
    <span class="nt">&lt;mediaPlacement</span> <span class="na">name=</span><span class="s">&quot;image&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;media</span> <span class="na">id=</span><span class="s">&quot;577286&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;path&gt;</span>images/1.jpg<span class="nt">&lt;/path&gt;</span>
        <span class="nt">&lt;caption&gt;</span><span class="cp">&lt;![CDATA[Cows at Three Mile Canyon provide resources such as methane and compost for on-farm operations.]]&gt;</span><span class="nt">&lt;/caption&gt;</span>
      <span class="nt">&lt;/media&gt;</span>
    <span class="nt">&lt;/mediaPlacement&gt;</span>
    <span class="nt">&lt;status&gt;</span>live<span class="nt">&lt;/status&gt;</span>
    <span class="nt">&lt;websitePlacement&gt;</span>
      <span class="nt">&lt;domain&gt;</span>www.newdomain.com<span class="nt">&lt;/domain&gt;</span>
      <span class="nt">&lt;section&gt;</span>/foodandfarms<span class="nt">&lt;/section&gt;</span>
      <span class="nt">&lt;startDate</span> <span class="na">dateFormat=</span><span class="s">&quot;yyyy-MM-dd HH:mm:ss zzz&quot;</span><span class="nt">&gt;</span>2007-04-29 14:00:00 PDT<span class="nt">&lt;/startDate&gt;</span>
    <span class="nt">&lt;/websitePlacement&gt;</span>
    <span class="nt">&lt;websitePlacement&gt;</span>
      <span class="nt">&lt;domain&gt;</span>www.olddomain.com<span class="nt">&lt;/domain&gt;</span>
      <span class="nt">&lt;section&gt;</span>/greenmarketing<span class="nt">&lt;/section&gt;</span>
      <span class="nt">&lt;startDate</span> <span class="na">dateFormat=</span><span class="s">&quot;yyyy-MM-dd HH:mm:ss zzz&quot;</span><span class="nt">&gt;</span>2007-04-29 14:00:00 PDT<span class="nt">&lt;/startDate&gt;</span>
    <span class="nt">&lt;/websitePlacement&gt;</span>
  <span class="nt">&lt;/content&gt;</span>
<span class="nt">&lt;/cmPublishImport&gt;</span></code></pre></div>


<h2>Enable the my_import Module and Run the Command Line Script</h2>

<p>Now (finally), it&rsquo;s time for some action. Enable your newly created my_import
module, and jump out to the shell. Assuming your Drupal root is at
/var/www/drupal, cd into that directory. Create the new directory
sites/default/files/migrated/images, and place a jpg named 1.jpg in that
directory. Now run the import script:</p>

<pre><code>php5 ./sites/all/modules/my_import/myimport.php  -f ./sites/all/modules/my_import/content.xml
</code></pre>

<p>With luck, the script will succeed, and you will have 1 row of data in your
clickability_articles table! If not, fix the error (if you&rsquo;re using the sample
data, let me know what went wrong and I&rsquo;ll fix it). Next up, Table Wizard
configuration.</p>

<h2>Expose the Table to Table Wizard</h2>

<p>All the hard work is done now - we can use a web UI from here on out. Visit
/admin/content/tw in your browser, and under the &ldquo;Add Existing Tables&rdquo;
fieldset, and select the tables you imported with myimport.php. If your tables
are huge (50K+ rows), you may want to select &ldquo;Skip full analysis&rdquo;. Click the
&ldquo;Add tables&rdquo; button. At this point, that&rsquo;s all we need from Table Wizard, but
I strongly encourage you click around a bit. The table analysis can tell you
some handy things about your data.</p>

<h2>Create the Migrate Content Set</h2>

<p>In the previous step, we essentially built a view that we can provide to the
Migrate module. Now we need to tell Migrate how to use the view. Visit the
Migrate settings at /admin/content/migrate/settings. If you can, implement the
changes it recommends to .htaccess as it will speed up the import
considerably. Also, make sure to expand the &ldquo;Migration support implemented in
the XYZ module&rdquo; fieldsets and enable the support you need for your import.
Now, visit the dashboard at /admin/content/migrate. Expand the &ldquo;Add a content
set&rdquo; fieldset, and fill in the values. When choosing the value for &ldquo;Source
view from which to import content&rdquo;, scroll down towards the bottom of the
list. All Table Wizard views are prefixed with &ldquo;tw: &rdquo;, so the one we&rsquo;re
looking for here is &ldquo;tw: clickability_issues (clickability_issues)&rdquo;. You can
leave &ldquo;View arguments&rdquo; and &ldquo;Weight&rdquo; to defaults. The next screen is where the
real magic happens. By interrogating the view, Migrate presents you with a map
fields form that allows us to select our source column from a dropdown to
assign to various node elements. If you have a setting that should remain
constant across all imported records (&ldquo;Node: Input format&rdquo; is usually a good
example), you can type in a default value here. The rest should be fairly self
explanatory. Click &ldquo;Submit changes&rdquo;, and you&rsquo;ll be taken back to the
dashboard.</p>

<h2>Run the Import, Clear the Import, Wash, Rinse, Repeat</h2>

<p>Now, the way I did my testing was to choose one row from the source table to
import. Grab its primary key and copy it to the clipboard. Check the box under
&ldquo;Import&rdquo; for our content set, then expand the &ldquo;Execute&rdquo; fieldset. Paste the ID
into the &ldquo;Source IDs:&rdquo; text field, and click the Run button. With any luck,
you will be returned to the dashboard, but the content set will show 1
imported. Hopefully there will be no errors, but if there are, find and fix
the problem. You can view the old primary key mapping to the node ID by going
back to /admin/content/tw and looking for a view named
migrate_map_si_articles. This table is created by the Migrate module &ndash; it
uses this table to track what has been imported, and what NID the imported
nodes have. Grab that nid, and load up /node/[nid]. If it looks good, then we
can to a bigger import. Go back to the Migrate dashboard, and this time click
the &ldquo;Clear&rdquo; checkbox next to the content set. Expand &ldquo;Execute&rdquo;, make sure all
fields are blank, and click the Run button. This process will &ldquo;unimport&rdquo; the
row we just imported. Now, depending on your row count, you may want to import
all rows and see what happens. Since I was dealing with thousands of nodes, I
did an import of just 100 nodes to make sure things were okay. To do this,
instead of specifying &ldquo;Source IDs&rdquo;, place the number 100 in &ldquo;Sample Size&rdquo;, and
click Run. To import everything, leave all fields blank. The power to quickly
and easily remove all changes made by the migrate module is huge. Because of
this &ldquo;safety net&rdquo;, it lets you work on the import within the same development
sandbox as your designers and themers. They&rsquo;ll appreciate having something
other than &ldquo;Lorem Ipsum&rdquo; to look at!</p>

<h2>Run to the Nearest Pub and Celebrate the Completion of Your Migration</h2>

<p>If I have to explain this to you, you&rsquo;re in the wrong field of work!</p>

<h2>Summary</h2>

<p>This post is my longest to date, and there&rsquo;s a good chance I missed some
things. By all means, let me know in the comments if you find any holes and
I&rsquo;ll get it corrected. I hope this case study helps some other Drupalers out
there - when I first started this project I couldn&rsquo;t find any examples on how
to get XML into Drupal using the Migrate module. Now Google has some spider
food :)</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Justin Ellison</span></span>

      




<time class='entry-date' datetime='2010-07-14T00:00:00-05:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>14</span><span class='date-suffix'>th</span>, <span class='date-year'>2010</span></span> <span class='time'>12:00 am</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/code/'>code</a>, <a class='category' href='/blog/categories/drupal/'>drupal</a>, <a class='category' href='/blog/categories/drupal-planet/'>drupal planet</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://sysadminsjourney.com/content/2010/07/14/case-study-migrating-xml-drupal-using-migrate" data-via="justinellison" data-counturl="http://sysadminsjourney.com/content/2010/07/14/case-study-migrating-xml-drupal-using-migrate" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/content/2010/04/23/my-thoughts-and-ramblings-drupalconsf-2010" title="Previous Post: My Thoughts and Ramblings on DrupalConSF 2010">&laquo; My Thoughts and Ramblings on DrupalConSF 2010</a>
      
      
        <a class="basic-alignment right" href="/content/2011/04/06/lead-sysadmin-position-available" title="Next Post: Lead SysAdmin position available">Lead SysAdmin position available &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Default -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-9978053499043694"
     data-ad-slot="5667084961"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/content/using-git-submodules-dynamic-puppet-environments">Using Git Submodules With Dynamic Puppet Environments</a>
      </li>
    
      <li class="post">
        <a href="/content/2011/11/14/vpsnet-review">VPS.net Review</a>
      </li>
    
      <li class="post">
        <a href="/content/2011/10/19/its-not-you-its-me-call-node-gallery-co-maintainers">It's Not You, It's Me: Call for Node Gallery Co-maintainers</a>
      </li>
    
      <li class="post">
        <a href="/content/2011/09/20/drupal-heroku">Drupal on Heroku</a>
      </li>
    
      <li class="post">
        <a href="/content/2011/04/19/selecting-right-cdn-your-website">Selecting the Right CDN for YOUR Website</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/justintime">@justintime</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'justintime',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("justinellison", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/justinellison" class="twitter-follow-button" data-show-count="false">Follow @justinellison</a>
  
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Justin Ellison -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'sysadminsjourney';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://sysadminsjourney.com/content/2010/07/14/case-study-migrating-xml-drupal-using-migrate';
        var disqus_url = 'http://sysadminsjourney.com/content/2010/07/14/case-study-migrating-xml-drupal-using-migrate';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
